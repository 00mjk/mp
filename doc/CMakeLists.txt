# Check requirements.
# Use specific version of Sphinx which fixes local search and has
# better C++ support.
check_module(sphinx have_sphinx EXTERNAL)
check_module(breathe have_breathe EXTERNAL)
if (NOT have_sphinx)
  message(STATUS "Target doc disabled (requires sphinx module)")
  return ()
endif ()
if (NOT have_breathe)
  message(STATUS "Target doc disabled (requires breathe module)")
  return ()
endif ()
find_program(DOXYGEN doxygen)
if (NOT DOXYGEN)
  message(STATUS "Target doc disabled (requires doxygen)")
  return ()
endif ()

set(DOXYGEN_INPUT_DIR ${CMAKE_CURRENT_SOURCE_DIR}/)
configure_file(Doxyfile.in Doxyfile @ONLY)

# Path to the script that extracts amplgsl docs.
set(EXTRACT_DOCS ${CMAKE_CURRENT_SOURCE_DIR}/extract-docs.py)

# amplgsl documentation source.
add_prefix(amplgsl_docs amplgsl/
  accuracy examples fdl freedoc front-matter gpl history index intro
  no-warranty rng)

# Add commands to copy .rst files to the binary directory.
# This is needed because some of the .rst files are autogenerated and
# therefore should be placed in the binary directory, while Sphinx only
# looks for source files in subdirectories of the directory containing
# the master file (index.rst).
set(doc_depends ${EXTRACT_DOCS})
foreach (doc ${docs} common index nl ${amplgsl_docs})
  set(src ${CMAKE_CURRENT_SOURCE_DIR}/${doc}.rst)
  set(dst ${CMAKE_CURRENT_BINARY_DIR}/${doc}.rst)
  add_custom_command(OUTPUT ${dst}
    COMMAND ${CMAKE_COMMAND} -E copy ${src} ${dst} DEPENDS ${src})
  set(doc_depends ${doc_depends} ${dst})
endforeach ()
add_prefix(doc_depends ../ ${MP_HEADERS})

add_custom_command(OUTPUT html/index.html
  COMMAND ${DOXYGEN}
  COMMAND python ${EXTRACT_DOCS}
  COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/../thirdparty/sphinx/sphinx-build.py
    -D "breathe_projects.mp=${CMAKE_CURRENT_BINARY_DIR}/doxyxml"
    -b html -c ${CMAKE_CURRENT_SOURCE_DIR} . html
  DEPENDS Doxyfile.in conf.py ${EXTRACT_DOCS} ../src/gsl/amplgsl.c ${doc_depends})
add_custom_target(doc DEPENDS html/index.html)

install(DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/html/ DESTINATION doc)
